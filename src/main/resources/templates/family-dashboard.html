<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å®¶å±ç«¯ä¸»é¡µ - å…»è€ç®¡ç†ç³»ç»Ÿ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    body {
      background: linear-gradient(to right, #e3f2fd, #f0f4f7);
      font-family: 'Segoe UI', sans-serif;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.4);
      border-radius: 15px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }
    footer {
      text-align: center;
      padding: 2rem;
      font-size: 0.9rem;
      color: #666;
    }
    .carousel-container {
      max-width: 600px;
      margin: 0 auto;
    }

    .carousel-photo {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      border-radius: 10px;
    }

    .photo-title {
      text-align: center;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #333;
    }

    .photo-subtitle {
      text-align: center;
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      color: #777;
    }
    .quick-widget {
      position: fixed;
      right: 20px;
      top: 40%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 999;
    }

    .widget-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      background-color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      border: 1px solid #ddd;
      transition: all 0.3s ease;
    }

    .widget-btn:hover {
      transform: translateX(-5px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      background-color: #f9f9f9;
    }

    .widget-btn i {
      font-size: 16px;
    }
    .hero-container {
      position: relative;
    }

    .system-notice {
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      z-index: 2;
      opacity: 0.95;
    }
    .hero-container {
      position: relative;
    }

    .system-notice-wrapper {
      position: absolute;
      top: 10px;
      left: 0;
      width: 100%;
      overflow: hidden;
      z-index: 10;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      padding: 5px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .system-notice-content {
      display: inline-block;
      white-space: nowrap;
      padding-left: 100%;
      animation: scroll-left 25s linear infinite;
      font-size: 1rem;
      font-weight: 500;
      color: #0c5460;
    }

    @keyframes scroll-left {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

  </style>
  <style>
    .section-header {
      padding-bottom: 1.5rem;
    }

    .section-icon {
      animation: bounce 2s infinite;
    }

    .article-card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border-radius: 8px;
      overflow: hidden;
    }

    .article-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }

    .article-card .card-title {
      transition: color 0.3s ease;
    }

    .article-card:hover .card-title {
      color: #0d6efd !important;
    }

    @keyframes bounce {
      0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
      40% {transform: translateY(-15px);}
      60% {transform: translateY(-7px);}
    }
  </style>
  <style>
    .photo-icon {
      font-size: 2.5rem; /* å›¾æ ‡å¤§å° */
      color: #0d6efd; /* å›¾æ ‡é¢œè‰² */
    }

    .photo-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-top: 5px;
    }

    .photo-subtitle {
      font-size: 1rem;
      color: #6c757d;
      margin-top: 5px;
    }

    /* æµ®åŠ¨åŠ¨ç”»æ•ˆæœ */
    .animate-camera {
      animation: float 2s ease-in-out infinite;
      display: inline-block;
    }

    @keyframes float {
      0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
      40% {transform: translateY(-15px);}
      60% {transform: translateY(-7px);}
    }
  </style>

  <link rel="stylesheet" href="/css/family-menu.css">
</head>
<body>
<!-- å¯¼èˆªæ ï¼ˆThymeleaf å ä½ï¼‰ -->
<!--<div th:replace="~{family-menu :: navbar}"></div>-->
<div th:replace="~{family-menu :: navbar2}"></div>
<div class="hero-container">
  <img src="/images/elder3.png" alt="å¤§ç…§ç‰‡" class="hero-photo w-100" />
  <div class="system-notice-wrapper">
    <div class="system-notice-content">
      ğŸ“¢ <strong>ç³»ç»Ÿé€šçŸ¥ï¼š</strong> æœ¬å‘¨å…­å°†ä¸¾åŠè€äººé›†ä½“ç”Ÿæ—¥ä¼šï¼Œæ¬¢è¿å®¶å±æŠ¥åå‚ä¸ï¼
    </div>
  </div>
</div>



<div class="container mt-4">

  <div class="glass-card p-4 mb-4">
    <h5 class="mb-3">ğŸ‘´ è€äººçŠ¶æ€æ€»è§ˆ</h5>
    <p>å§“åï¼š<span th:text="${elder.name}"></span>ï¼ˆ<span th:text="${elder.age}"></span>å²ï¼‰</p>

    <div th:if="${#lists.isEmpty(healthRecordsNew) == false}">
      <p>
        è¡€ç³–ï¼š<span th:text="${healthRecordsNew.bloodSugar}">76</span> bpm
        è¡€å‹ï¼š<span th:text="${healthRecordsNew.bloodPressure}">120/80</span> mmHg
      </p>
      <p class="text-muted">
        <small>
          ä¸Šä¸€æ¬¡æ›´æ–°ï¼š<span th:text="${#dates.format(healthRecordsNew.recordDate, 'MMæœˆddæ—¥')}"></span>
        </small>
      </p>

    </div>

    <div th:if="${#lists.isEmpty(healthRecordsNew)}">
      <p>æš‚æ— å¥åº·æ•°æ®è®°å½•</p>
    </div>
  </div>

  <!-- å›¾è¡¨éƒ¨åˆ† -->
  <div class="glass-card p-4 mb-5">
    <h5><i class="fas fa-heartbeat"></i> å¥åº·æ•°æ®å¯è§†</h5>
    <canvas id="healthDataChart" height="100"></canvas>
  </div>

  <!-- ç”Ÿæ´»ç…§ç‰‡å¢™ -->
  <!-- æ ‡é¢˜è¯´æ˜ -->
  <div class="carousel-container text-center">
    <div class="d-flex flex-column align-items-center">
      <!-- ç›¸æœºå›¾æ ‡ -->
      <div class="photo-icon mb-2">
        <i class="fas fa-camera-retro animate-camera"></i>
      </div>
      <!-- æ ‡é¢˜ -->
      <div class="photo-title">
        è€äººè¿‘æœŸç”Ÿæ´»ç…§
      </div>
      <!-- å‰¯æ ‡é¢˜ -->
      <div class="photo-subtitle">
        å±•ç¤ºè€äººæ—¥å¸¸ç”Ÿæ´»ä¸­çš„æ¸©é¦¨ç¬é—´ï¼Œè®°å½•æ¯ä¸€ä¸ªç¾å¥½æ—¶åˆ»
      </div>
    </div>
  </div>

  <!-- å¹»ç¯ç‰‡ç»„ä»¶ -->
  <div id="dualPhotoCarousel" class="carousel slide carousel-container mb-4" data-bs-ride="carousel">
    <div class="carousel-inner">
      <!-- ç¬¬ä¸€ç»„ -->
      <div class="carousel-item active" th:if="${elderPhotos.size() > 1}">
        <div class="row">
          <div class="col-6">
            <img th:src="${elderPhotos[0].photoPath}" class="carousel-photo" alt="å›¾1" />
          </div>
          <div class="col-6">
            <img th:src="${elderPhotos[1].photoPath}" class="carousel-photo" alt="å›¾2" />
          </div>
        </div>
      </div>

      <!-- åç»­ç»„ï¼šå·¦è¾¹ä¸ºä¸Šä¸€å¼ ï¼Œå³è¾¹æ–°å›¾ -->
      <div class="carousel-item" th:each="photo, stat : ${elderPhotos}" th:if="${stat.index >= 2}">
        <div class="row">
          <div class="col-6">
            <img th:src="${elderPhotos[stat.index - 1].photoPath}" class="carousel-photo" alt="å·¦å›¾" />
          </div>
          <div class="col-6">
            <img th:src="${photo.photoPath}" class="carousel-photo" alt="å³å›¾" />
          </div>
        </div>
      </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <button class="carousel-control-prev" type="button" data-bs-target="#dualPhotoCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#dualPhotoCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon"></span>
    </button>
  </div>
  <section class="article-section py-5">
    <div class="container">
      <!-- æ”¹è¿›åçš„æ ‡é¢˜éƒ¨åˆ† -->
      <div class="section-header text-center mb-5 position-relative">
        <div class="section-icon mb-3">
          <i class="fas fa-book-open fa-3x text-primary"></i>
        </div>
        <h2 class="display-5 fw-bold mb-3">
                <span class="position-relative">
                    ç²¾é€‰æ–‡ç« æ¨è
                    <span class="position-absolute bottom-0 start-0 end-0 mx-auto" style="height: 3px; width: 80px; background: linear-gradient(90deg, #0d6efd, #6f42c1);"></span>
                </span>
        </h2>
        <p class="lead text-muted">ä¸“ä¸šæŠ¤ç†çŸ¥è¯†ä¸å®ç”¨å…»è€æŒ‡å—</p>
      </div>

      <div class="row g-4">
        <!-- æ–‡ç« å¡ç‰‡ï¼ˆå…±12ä¸ªï¼Œå¤åˆ¶ä¸‹é¢è¿™æ®µæ”¹å†…å®¹ï¼‰ -->
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSy9-OZBxQmtNsw8aQICK1kTe6HIWZc3btHIA&s'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">å¥åº·å…»è€ï¼šè®©çˆ±å»¶ç»­åˆ°è€å¹´ç”Ÿæ´»çš„æ¯ä¸€å¤©</h5>
              <p class="card-text text-muted">äº†è§£å¦‚ä½•ä¸é•¿è€…å»ºç«‹ä¿¡ä»»ï¼Œæ”¹å–„æ—¥å¸¸äº’åŠ¨ä½“éªŒã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmZ2HaKvAQHyfMLNIKsZopUdTQwkh7ESDRvg&s'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">ç…§æŠ¤ä¸­çš„å…±æƒ…ä¸æ²Ÿé€šæŠ€å·§</h5>
              <p class="card-text text-muted">å­¦ä¹ å¦‚ä½•ç†è§£é•¿è€…éœ€æ±‚ï¼Œå»ºç«‹æœ‰æ•ˆæ²Ÿé€šæ¡¥æ¢ã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://paper.people.com.cn/rmrbhwb/images/1/20210805/1628101167074_1.jpg'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">è€å¹´è¥å…»è†³é£ŸæŒ‡å—</h5>
              <p class="card-text text-muted">ç§‘å­¦æ­é…è¥å…»ï¼Œä¸ºé•¿è€…æä¾›å¥åº·é¥®é£Ÿæ–¹æ¡ˆã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR1QM8piiqD7m4LnthhBx7IxLqNEBH0lwgXEQ&s'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">å±…å®¶å…»è€ç¯å¢ƒæ”¹é€ </h5>
              <p class="card-text text-muted">æ‰“é€ å®‰å…¨èˆ’é€‚çš„å±…å®¶å…»è€ç¯å¢ƒå®ç”¨æŠ€å·§ã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSEzm_xusj53swOkqmgar5yFwbRX1WjxK1Sng&s'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">è€å¹´å¿ƒç†å¥åº·å…³æ€€</h5>
              <p class="card-text text-muted">å…³æ³¨é•¿è€…å¿ƒç†å¥åº·ï¼Œé¢„é˜²è€å¹´æŠ‘éƒã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS72iwhop_zfjXNXXPM3E-rCkxlw-p-B4CgDQ&s'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">è€å¹´å¸¸è§ç–¾ç—…é¢„é˜²</h5>
              <p class="card-text text-muted">è®¤è¯†è€å¹´å¸¸è§ç–¾ç—…åŠé¢„é˜²æªæ–½ã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://imgs.699pic.com/images/402/568/908.jpg!list1x.v2'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">åº·å¤æŠ¤ç†å®ç”¨æŠ€å·§</h5>
              <p class="card-text text-muted">æœ¯ååŠç–¾ç—…åº·å¤æœŸçš„ä¸“ä¸šæŠ¤ç†æ–¹æ³•ã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>

        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
          <a href="/articles/article1.html" class="article-card card h-100 border-0 shadow-sm text-decoration-none" target="_blank">
            <div class="article-image card-img-top" style="height: 180px; background-image: url('https://imgs.699pic.com/images/401/766/045.jpg!list1x.v2'); background-size: cover; background-position: center;"></div>
            <div class="article-content card-body">
              <h5 class="card-title text-dark">è€å¹´æ´»åŠ¨è®¾è®¡æŒ‡å—</h5>
              <p class="card-text text-muted">ä¸°å¯Œé•¿è€…ç”Ÿæ´»çš„è¶£å‘³æ´»åŠ¨è®¾è®¡æ–¹æ¡ˆã€‚</p>
            </div>
            <div class="card-footer bg-transparent border-top-0">
              <small class="text-primary">é˜…è¯»æ›´å¤š <i class="fas fa-arrow-right ms-1"></i></small>
            </div>
          </a>
        </div>
      </div>
    </div>
  </section>


</div>

<!-- è¿”å›é¡¶éƒ¨æŒ‰é’® -->
<button id="backToTopBtn" class="btn btn-primary rounded-circle" style="position: fixed; bottom: 40px; right: 40px; display: none; z-index: 999;">
  <i class="fas fa-arrow-up"></i>
</button>
<button id="chatToggleBtn" class="btn btn-success rounded-circle" style="position: fixed; bottom: 100px; right: 40px; z-index: 1000;">
  <i class="fas fa-robot"></i>
</button>

<!-- èŠå¤©å¼¹å‡ºæ¡† -->
<div id="chatBox" class="glass-card p-3" style="position: fixed; bottom: 160px; right: 40px; width: 300px; max-height: 400px; display: none; z-index: 1000; overflow-y: auto;">
  <div class="mb-2">
    <strong><i class="fas fa-comment-dots me-1"></i>Aiå¥åº·åŠ©æ‰‹</strong>
  </div>
  <div id="chatMessages" style="height: 220px; overflow-y: auto; font-size: 0.9rem; background: #f9f9f9; padding: 8px; border-radius: 6px; margin-bottom: 10px;"></div>
  <div class="input-group">
    <input type="text" id="chatInput" class="form-control" placeholder="è¾“å…¥å†…å®¹..." />
    <button class="btn btn-primary" onclick="sendChat()">å‘é€</button>
  </div>
</div>


<footer>
  &copy; 2025 å…»è€ç®¡ç†ç³»ç»Ÿ | å®¶å±ç«¯ä¸»é¡µ
</footer>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script th:inline="javascript">
  /*<![CDATA[*/
  const labels = [[${chartLabels}]];
  const bloodPressureData = [[${chartBloodPressure}]];
  const bloodSugarData = [[${chartBloodSugar}]];
  /*]]>*/
</script>

<script>
  const ctx = document.getElementById('healthDataChart').getContext('2d');
  const healthDataChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'æ”¶ç¼©å‹ (mmHg)',
          data: bloodPressureData,
          borderColor: 'rgba(75, 192, 192, 1)',
          tension: 0.3,
          fill: false,
          yAxisID: 'y',
        },
        {
          label: 'è¡€ç³– (mmol/L)',
          data: bloodSugarData,
          borderColor: 'rgba(255, 99, 132, 1)',
          tension: 0.3,
          fill: false,
          yAxisID: 'y1',
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: {
          type: 'linear',
          position: 'left',
          title: {
            display: true,
            text: 'æ”¶ç¼©å‹ (mmHg)'
          },
          beginAtZero: false
        },
        y1: {
          type: 'linear',
          position: 'right',
          title: {
            display: true,
            text: 'è¡€ç³– (mmol/L)'
          },
          beginAtZero: false,
          grid: {
            drawOnChartArea: false,
          }
        }
      }
    }
  });
</script>



<script>
  // æ˜¾ç¤º/éšè—æŒ‰é’®é€»è¾‘
  window.addEventListener("scroll", function () {
    const btn = document.getElementById("backToTopBtn");
    if (document.documentElement.scrollTop > 200) {
      btn.style.display = "block";
    } else {
      btn.style.display = "none";
    }
  });

  // å¹³æ»‘è¿”å›é¡¶éƒ¨
  document.getElementById("backToTopBtn").addEventListener("click", function () {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
</script>



<!-- ä½ ä¹‹å‰çš„æŒ‰é’®å’ŒèŠå¤©æ¡†ä¿æŒä¸å˜ -->

<script>
  document.getElementById('chatToggleBtn').addEventListener('click', () => {
    const chatBox = document.getElementById('chatBox');
    if (chatBox.style.display === 'none' || chatBox.style.display === '') {
      chatBox.style.display = 'block';

      // æ‰“å¼€æ—¶å¦‚æœå†å²æ¶ˆæ¯ä¸ºç©ºï¼ŒåŠ å…¥æ¬¢è¿è¯­
      if (chatHistory.length === 0) {
        chatHistory.push({ role: 'assistant', content: 'æ‚¨å¥½ï¼Œæˆ‘æ˜¯aiå¥åº·åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨ï¼Ÿ' });
        renderMessages();
      }
    } else {
      chatBox.style.display = 'none';
    }
  });

  // å­˜å‚¨èŠå¤©å†å²æ¶ˆæ¯ï¼Œæ ¼å¼åŒåç«¯ä¸€è‡´
  let chatHistory = [];

  // æ¸²æŸ“èŠå¤©è®°å½•
  function renderMessages() {
    const chatMessagesDiv = document.getElementById('chatMessages');
    chatMessagesDiv.innerHTML = '';
    chatHistory.forEach(msg => {
      const div = document.createElement('div');
      div.style.marginBottom = '8px';
      if (msg.role === 'user') {
        div.style.textAlign = 'right';
        div.innerHTML = `<b>æˆ‘ï¼š</b>${msg.content}`;
      } else {
        div.style.textAlign = 'left';
        div.innerHTML = `<b>AIï¼š</b>${msg.content}`;
      }
      chatMessagesDiv.appendChild(div);
    });
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
  }

  // å‘é€æ¶ˆæ¯åˆ°åç«¯
  async function sendChat() {
    const input = document.getElementById('chatInput');
    const userInput = input.value.trim();
    if (!userInput) return;

    // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²
    chatHistory.push({ role: 'user', content: userInput });
    renderMessages();

    input.value = '';
    input.disabled = true;

    try {
      // ä» meta æ ‡ç­¾è·å– CSRF token å’Œ header åç§°
      const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
      const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

      const response = await fetch('/api/chat/doubao', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          [csrfHeader]: csrfToken  // â† åŠ ä¸Š CSRF token
        },
        body: JSON.stringify({ messages: chatHistory })
      });

      const data = await response.json();

      chatHistory.push({ role: 'assistant', content: data.answer || 'æ²¡æœ‰å›ç­”' });
      renderMessages();
    } catch (err) {
      alert('è¯·æ±‚å¤±è´¥ï¼š' + err.message);
    } finally {
      input.disabled = false;
      input.focus();
    }
  }


  // æŒ‰å›è½¦ä¹Ÿå‘é€
  document.getElementById('chatInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      sendChat();
    }
  });
</script>







</body>
</html>
