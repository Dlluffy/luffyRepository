<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>ğŸ”” æœåŠ¡é¢„çº¦ç®¡ç†</title>
    <link rel="stylesheet" th:href="@{/css/main.css}"/>
    <style>
        .action-buttons {
            display: inline-flex;
            gap: 0.5rem;
        }

        .action-buttons form {
            margin: 0;
        }

        .col-actions {
            white-space: nowrap;
            width: 1%;
        }

        .btn, .page-link {
            text-decoration: none;
        }

        .pagination {
            list-style: none;
            margin: 1rem 0;
            padding: 0;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .pagination li {
            margin: 0;
        }

        .pagination li.disabled .btn {
            opacity: 0.5;
            pointer-events: none;
        }

        .pagination li.active .btn {
            background: #357ABD;
            color: #fff;
        }
    </style>
</head>
<body>

<!-- é¡µå¤´ + å¯¼èˆª -->
<div th:insert="~{fragments :: site-header}"></div>
<div th:insert="~{fragments :: site-nav}"></div>

<main class="container">

    <!-- æ–°å¢é¢„çº¦ -->
    <section class="card">
        <h2>â• æ–°å¢æœåŠ¡é¢„çº¦</h2>
        <form th:action="@{/appointments}" th:object="${newAppt}" method="post" class="form">
            <div class="form-group">
                <label>è€äºº
                    <select th:field="*{elderId}" required>
                        <option value="" disabled selected>è¯·é€‰æ‹©è€äºº</option>
                        <option th:each="e : ${elders}"
                                th:value="${e.elderId}"
                                th:text="${e.name}">å¼ ä¸‰
                        </option>
                    </select>
                </label>
            </div>
            <div class="form-group">
                <label>å®¶å±ç”¨æˆ·
                    <select th:field="*{userId}">
                        <option value="" disabled selected>è¯·é€‰æ‹©å®¶å±</option>
                        <option th:each="u : ${users}"
                                th:value="${u.userId}"
                                th:text="${u.name}">æå››
                        </option>
                    </select>
                </label>
            </div>
            <div class="form-group">
                <label>æœåŠ¡ç±»å‹
                    <select th:field="*{serviceType}">
                        <option value="" disabled selected>è¯·é€‰æ‹©æœåŠ¡</option>
                        <option value="ä¸Šé—¨æŠ¤ç†">ä¸Šé—¨æŠ¤ç†</option>
                        <option value="åº·å¤è®­ç»ƒ">åº·å¤è®­ç»ƒ</option>
                    </select>
                </label>
            </div>
            <!-- é‡‘é¢ï¼ˆæ•´æ•°ï¼Œå•ä½ï¼šå…ƒï¼‰ -->
            <div class="form-group">
                <label>é‡‘é¢ï¼ˆå¯ç•™ç©ºï¼Œæ”¯æŒä¸¤ä½å°æ•°ï¼‰
                    <input type="number"
                           name="fee"
                           step="0.01"
                    min="0"
                    placeholder="ä¾‹å¦‚ 200.00"/>
                </label>
            </div>


            <div class="form-group">
                <label>é¢„çº¦æ—¶é—´
                    <!-- æ”¹ä¸ºæ—¥æœŸ+æ—¶é—´ -->
                    <input type="datetime-local" th:field="*{appointmentTime}" required/>
                </label>
            </div>
            <div class="form-group">
                <label>æ¢è®¿åŸå› 
                    <input type="text" th:field="*{reason}" placeholder="å¦‚ï¼šæ—¥å¸¸æ¢è§†"/>
                </label>
            </div>
            <button class="btn primary" type="submit">ä¿å­˜</button>
        </form>
    </section>

    <!-- é¢„çº¦åˆ—è¡¨ -->
    <section class="card">
        <h2>ğŸ“‹ é¢„çº¦åˆ—è¡¨</h2>
        <div id="apptTable" th:fragment="apptTable">
            <table class="table">
                <thead>
                <tr>
                    <th>é¢„çº¦ID</th>
                    <th>è€äººID</th>
                    <th>å®¶å±ç”¨æˆ·ID</th>
                    <th>æœåŠ¡ç±»å‹</th>
                    <th>é¢„çº¦æ—¶é—´</th>
                    <th>æ¢è®¿åŸå› </th>
                    <th>çŠ¶æ€</th>
                    <th>è´¦å•ID</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                    <th class="col-actions">æ“ä½œ</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="a : ${appointments}">
                    <td th:text="${a.appointmentId}">1</td>
                    <td th:text="${a.elderId}">101</td>
                    <td th:text="${a.userId}">501</td>
                    <td th:text="${a.serviceType}">ä¸Šé—¨æŠ¤ç†</td>
                    <!-- å±•ç¤ºå®Œæ•´æ—¥æœŸ+æ—¶é—´ -->
                    <td th:text="${#temporals.format(a.appointmentTime,'yyyy-MM-dd HH:mm')}">
                        2025-05-30 10:24
                    </td>
                    <td th:text="${a.reason}">æ—¥å¸¸æ¢è§†</td>
                    <td th:text="${a.status}">æœªæ”¯ä»˜</td>
                    <td th:text="${a.billId != null ? a.billId : 'â€”'}">â€”</td>
                    <td th:text="${#dates.format(a.createdAt,'yyyy-MM-dd HH:mm')}">
                        2025-05-26 09:00
                    </td>
                    <td th:text="${#dates.format(a.updatedAt,'yyyy-MM-dd HH:mm')}">
                        2025-05-26 10:00
                    </td>
                    <td class="col-actions">
                        <div class="action-buttons">
                            <!-- å–æ¶ˆé¢„çº¦ -->
                            <form th:if="${a.status != 'å·²å–æ¶ˆ'}"
                                  th:action="@{|/appointments/${a.appointmentId}/cancel|}"
                                  method="post"
                                  onsubmit="return confirm('ç¡®è®¤è¦å–æ¶ˆæ­¤é¢„çº¦ï¼Ÿ');">
                                <button type="submit" class="btn">å–æ¶ˆ</button>
                            </form>
                            <!-- æ”¯ä»˜ -->
                            <form th:if="${a.status == 'æœªæ”¯ä»˜'}"
                                  th:action="@{|/appointments/${a.appointmentId}/pay|}"
                                  method="post"
                                  onsubmit="return confirm('ç¡®è®¤è¦æ”¯ä»˜ï¼Ÿ');">
                                <button type="submit" class="btn primary">æ”¯ä»˜</button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>

            <!-- åˆ†é¡µ -->
            <ul class="pagination">
                <li th:classappend="${pageInfo.hasPreviousPage} ? '' : 'disabled'">
                    <a href="#"
                       th:attr="data-page=${pageInfo.prePage}"
                       class="btn page-link">Â«</a>
                </li>
                <li th:each="i : ${#numbers.sequence(1, pageInfo.pages)}"
                    th:classappend="${i == pageInfo.pageNum} ? 'active'">
                    <a href="#"
                       th:attr="data-page=${i}"
                       class="btn page-link"
                       th:text="${i}">1</a>
                </li>
                <li th:classappend="${pageInfo.hasNextPage} ? '' : 'disabled'">
                    <a href="#"
                       th:attr="data-page=${pageInfo.nextPage}"
                       class="btn page-link">Â»</a>
                </li>
            </ul>
        </div>
    </section>

</main>

<div th:insert="~{fragments :: site-footer}"></div>

<!-- AJAX åˆ†é¡µè„šæœ¬ -->
<script>
    document.addEventListener('click', e => {
        if (e.target.matches('.page-link')) {
            e.preventDefault();
            const page = e.target.getAttribute('data-page');
            fetch(`/appointments?pageNum=${page}`, {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
                .then(r => r.text())
                .then(html => {
                    const frag = document.createRange().createContextualFragment(html);
                    const newTbl = frag.querySelector('#apptTable');
                    document.querySelector('#apptTable').replaceWith(newTbl);
                });
        }
    });
</script>

</body>
</html>
